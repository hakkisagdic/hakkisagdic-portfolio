# =============================================================================
# Gitflow Automation with Draft PRs
# =============================================================================
# Bu workflow, Gitflow stratejisini otomatize eder:
# - dev â†’ staging: Draft PR oluÅŸturur/gÃ¼nceller
# - staging â†’ main: Draft PR oluÅŸturur/gÃ¼nceller (release)
# - Hotfix desteÄŸi
#
# ğŸ“Œ AkÄ±ÅŸ:
# 1. dev'e push â†’ Draft PR (devâ†’staging) aÃ§Ä±lÄ±r
# 2. dev'e yeni push'lar â†’ AynÄ± PR otomatik gÃ¼ncellenir
# 3. PR'Ä± "Ready for review" yap â†’ Merge et â†’ STAGING deploy
# 4. staging merge â†’ Draft PR (stagingâ†’main) aÃ§Ä±lÄ±r
# 5. PR'Ä± "Ready for review" yap â†’ Merge et â†’ PROD deploy
# =============================================================================

name: ğŸ”„ Gitflow Automation

on:
  push:
    branches:
      - dev
      - staging
      - 'hotfix/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'create-pr'
        type: choice
        options:
          - create-pr
          - sync-branches

jobs:
  # ===========================================================================
  # Dev â†’ Staging Draft PR
  # ===========================================================================
  dev-to-staging:
    name: ğŸ“¤ Draft PR (dev â†’ staging)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          git fetch origin staging:staging 2>/dev/null || echo "staging branch may not exist"
          CHANGES=$(git log staging..dev --oneline 2>/dev/null | wc -l || echo "0")
          COMMIT_LIST=$(git log staging..dev --oneline 2>/dev/null | head -20 || echo "")
          echo "count=$CHANGES" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Found $CHANGES new commits in dev"
          
          # Store commit list for PR body
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "commits<<$EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_LIST" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Check existing PR
        id: existing_pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:dev`,
              base: 'staging',
              state: 'open'
            });
            
            if (prs.length > 0) {
              console.log(`Found existing PR #${prs[0].number}`);
              core.setOutput('exists', 'true');
              core.setOutput('number', prs[0].number);
            } else {
              console.log('No existing PR found');
              core.setOutput('exists', 'false');
            }

      - name: Create Draft PR
        if: steps.changes.outputs.count > 0 && steps.existing_pr.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ [Draft] dev â†’ staging',
              head: 'dev',
              base: 'staging',
              draft: true,
              body: `## ğŸ“‹ Gitflow: dev â†’ staging

            Bu Draft PR, **dev** branch'indeki deÄŸiÅŸiklikleri **staging**'e taÅŸÄ±r.

            ### ğŸ“Š DeÄŸiÅŸiklikler
            - Toplam: ${{ steps.changes.outputs.count }} commit
            - Kaynak: \`dev\`
            - Hedef: \`staging\`

            ### ğŸ“ Son Commitler
            \`\`\`
            ${{ steps.changes.outputs.commits }}
            \`\`\`

            ### âœ… Merge Ã–ncesi Checklist
            - [ ] Kod review tamamlandÄ±
            - [ ] Testler geÃ§iyor
            - [ ] STAGING'e deploy iÃ§in hazÄ±r

            ### ğŸš€ Sonraki AdÄ±m
            1. Bu PR'Ä± "Ready for review" yap
            2. Review ve onay al
            3. Merge et â†’ Otomatik STAGING deploy

            ---
            ğŸ¤– *Bu PR otomatik oluÅŸturuldu. dev'e yeni push'lar bu PR'Ä± gÃ¼nceller.*
            `
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['gitflow', 'dev-to-staging', 'draft']
            });
            
            console.log(`Created Draft PR #${pr.number}`);

      - name: Update existing PR
        if: steps.changes.outputs.count > 0 && steps.existing_pr.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.existing_pr.outputs.number }};
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: `## ğŸ“‹ Gitflow: dev â†’ staging

            Bu Draft PR, **dev** branch'indeki deÄŸiÅŸiklikleri **staging**'e taÅŸÄ±r.

            ### ğŸ“Š DeÄŸiÅŸiklikler (GÃ¼ncellendi âœ¨)
            - Toplam: ${{ steps.changes.outputs.count }} commit
            - Kaynak: \`dev\`
            - Hedef: \`staging\`
            - Son gÃ¼ncelleme: ${new Date().toISOString()}

            ### ğŸ“ Son Commitler
            \`\`\`
            ${{ steps.changes.outputs.commits }}
            \`\`\`

            ### âœ… Merge Ã–ncesi Checklist
            - [ ] Kod review tamamlandÄ±
            - [ ] Testler geÃ§iyor
            - [ ] STAGING'e deploy iÃ§in hazÄ±r

            ### ğŸš€ Sonraki AdÄ±m
            1. Bu PR'Ä± "Ready for review" yap
            2. Review ve onay al
            3. Merge et â†’ Otomatik STAGING deploy

            ---
            ğŸ¤– *Bu PR otomatik gÃ¼ncellendi. Son push: ${context.sha.substring(0, 8)}*
            `
            });
            
            // Add comment about update
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ğŸ”„ **PR GÃ¼ncellendi**\n\nYeni commit eklendi: \`${context.sha.substring(0, 8)}\`\n\nToplam: ${{ steps.changes.outputs.count }} commit staging'e merge bekliyor.`
            });
            
            console.log(`Updated PR #${prNumber}`);

  # ===========================================================================
  # Staging â†’ Main Draft PR (Release)
  # ===========================================================================
  staging-to-main:
    name: ğŸš€ Draft Release PR (staging â†’ main)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          CHANGES=$(git log origin/main..staging --oneline | wc -l)
          COMMIT_LIST=$(git log origin/main..staging --oneline | head -20 || echo "")
          echo "count=$CHANGES" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Found $CHANGES new commits ready for release"
          
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "commits<<$EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_LIST" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Generate version
        id: version
        run: |
          VERSION="v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: Check existing PR
        id: existing_pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:staging`,
              base: 'main',
              state: 'open'
            });
            
            if (prs.length > 0) {
              console.log(`Found existing PR #${prs[0].number}`);
              core.setOutput('exists', 'true');
              core.setOutput('number', prs[0].number);
            } else {
              console.log('No existing PR found');
              core.setOutput('exists', 'false');
            }

      - name: Create Draft Release PR
        if: steps.changes.outputs.count > 0 && steps.existing_pr.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš€ [Release Draft] ${{ steps.version.outputs.version }}',
              head: 'staging',
              base: 'main',
              draft: true,
              body: `## ğŸš€ Release: ${{ steps.version.outputs.version }}

            Bu Draft PR, **staging** branch'indeki deÄŸiÅŸiklikleri **production (main)**'e release eder.

            ### ğŸ“Š Release Bilgisi
            - Version: \`${{ steps.version.outputs.version }}\`
            - Toplam: ${{ steps.changes.outputs.count }} commit
            - Kaynak: \`staging\`
            - Hedef: \`main\` (production)

            ### ğŸ“ DeÄŸiÅŸiklikler
            \`\`\`
            ${{ steps.changes.outputs.commits }}
            \`\`\`

            ### âš ï¸ Pre-Release Checklist
            - [ ] TÃ¼m Ã¶zellikler staging'de test edildi
            - [ ] Kritik bug yok
            - [ ] Database migration hazÄ±r (varsa)
            - [ ] Rollback planÄ± hazÄ±r
            - [ ] TakÄ±m bilgilendirildi

            ### ğŸš€ Sonraki AdÄ±m
            1. Bu PR'Ä± "Ready for review" yap
            2. Final review ve onay al
            3. Merge et â†’ Otomatik PROD deploy (2 replica)

            ---
            ğŸ¤– *Bu release PR otomatik oluÅŸturuldu.*
            `
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['gitflow', 'release', 'staging-to-main', 'draft']
            });
            
            console.log(`Created Draft Release PR #${pr.number}`);

      - name: Update existing Release PR
        if: steps.changes.outputs.count > 0 && steps.existing_pr.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.existing_pr.outputs.number }};
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              title: 'ğŸš€ [Release Draft] ${{ steps.version.outputs.version }}',
              body: `## ğŸš€ Release: ${{ steps.version.outputs.version }}

            Bu Draft PR, **staging** branch'indeki deÄŸiÅŸiklikleri **production (main)**'e release eder.

            ### ğŸ“Š Release Bilgisi (GÃ¼ncellendi âœ¨)
            - Version: \`${{ steps.version.outputs.version }}\`
            - Toplam: ${{ steps.changes.outputs.count }} commit
            - Kaynak: \`staging\`
            - Hedef: \`main\` (production)
            - Son gÃ¼ncelleme: ${new Date().toISOString()}

            ### ğŸ“ DeÄŸiÅŸiklikler
            \`\`\`
            ${{ steps.changes.outputs.commits }}
            \`\`\`

            ### âš ï¸ Pre-Release Checklist
            - [ ] TÃ¼m Ã¶zellikler staging'de test edildi
            - [ ] Kritik bug yok
            - [ ] Database migration hazÄ±r (varsa)
            - [ ] Rollback planÄ± hazÄ±r
            - [ ] TakÄ±m bilgilendirildi

            ### ğŸš€ Sonraki AdÄ±m
            1. Bu PR'Ä± "Ready for review" yap
            2. Final review ve onay al
            3. Merge et â†’ Otomatik PROD deploy (2 replica)

            ---
            ğŸ¤– *Bu release PR otomatik gÃ¼ncellendi. Son push: ${context.sha.substring(0, 8)}*
            `
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ğŸ”„ **Release PR GÃ¼ncellendi**\n\nYeni commit eklendi: \`${context.sha.substring(0, 8)}\`\n\nVersion: \`${{ steps.version.outputs.version }}\``
            });
            
            console.log(`Updated Release PR #${prNumber}`);

  # ===========================================================================
  # Hotfix â†’ Main & Dev
  # ===========================================================================
  hotfix:
    name: ğŸ”¥ Hotfix PRs
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/hotfix/')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract hotfix name
        id: hotfix
        run: |
          HOTFIX_NAME=${GITHUB_REF#refs/heads/hotfix/}
          echo "name=$HOTFIX_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ”¥ Hotfix: $HOTFIX_NAME"

      - name: Create Hotfix PR to Main
        uses: actions/github-script@v7
        with:
          script: |
            // Check if PR already exists
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${{ github.ref_name }}`,
              base: 'main',
              state: 'open'
            });
            
            if (prs.length === 0) {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”¥ [Hotfix] ${{ steps.hotfix.outputs.name }} â†’ main',
                head: '${{ github.ref_name }}',
                base: 'main',
                draft: false,
                body: `## ğŸ”¥ Hotfix: ${{ steps.hotfix.outputs.name }}

            **URGENT:** Bu hotfix doÄŸrudan production'a uygulanacak.

            ### âš ï¸ Hotfix Checklist
            - [ ] Issue tanÄ±mlandÄ± ve dokÃ¼mante edildi
            - [ ] Fix lokal test edildi
            - [ ] Yan etki yok
            - [ ] Hemen deploy iÃ§in hazÄ±r

            ---
            ğŸ¤– *Bu hotfix PR otomatik oluÅŸturuldu*
            `
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['gitflow', 'hotfix', 'urgent']
              });
            }

      - name: Create Hotfix PR to Dev
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${{ github.ref_name }}`,
              base: 'dev',
              state: 'open'
            });
            
            if (prs.length === 0) {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”¥ [Hotfix Backport] ${{ steps.hotfix.outputs.name }} â†’ dev',
                head: '${{ github.ref_name }}',
                base: 'dev',
                draft: false,
                body: `## ğŸ”¥ Hotfix Backport: ${{ steps.hotfix.outputs.name }}

            Bu PR, hotfix'i dev branch'ine de uygular.

            ---
            ğŸ¤– *Bu hotfix backport PR otomatik oluÅŸturuldu*
            `
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['gitflow', 'hotfix', 'backport']
              });
            }
