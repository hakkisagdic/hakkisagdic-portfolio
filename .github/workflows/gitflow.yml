# =============================================================================
# Gitflow Automation
# =============================================================================
# Bu workflow, Gitflow stratejisini otomatize eder:
# - dev â†’ staging: Otomatik PR oluÅŸturur
# - staging â†’ main: Otomatik PR oluÅŸturur (release)
# - Hotfix desteÄŸi
# =============================================================================

name: ğŸ”„ Gitflow Automation

on:
  push:
    branches:
      - dev
      - staging
      - 'hotfix/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'create-pr'
        type: choice
        options:
          - create-pr
          - sync-branches

jobs:
  # ===========================================================================
  # Dev â†’ Staging PR
  # ===========================================================================
  dev-to-staging:
    name: ğŸ“¤ Create PR (dev â†’ staging)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          git fetch origin staging:staging 2>/dev/null || echo "staging branch may not exist"
          CHANGES=$(git log staging..dev --oneline 2>/dev/null | wc -l || echo "0")
          echo "count=$CHANGES" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Found $CHANGES new commits in dev"

      - name: Create Pull Request
        if: steps.changes.outputs.count > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: dev
          base: staging
          title: "ğŸ”„ [Gitflow] Merge dev into staging"
          body: |
            ## ğŸ“‹ Automatic Gitflow PR
            
            Bu PR, **dev** branch'indeki deÄŸiÅŸiklikleri **staging**'e taÅŸÄ±r.
            
            ### ğŸ“Š Changes
            - Commits: ${{ steps.changes.outputs.count }} new commit(s)
            - Source: `dev`
            - Target: `staging`
            
            ### âœ… Checklist
            - [ ] Code review completed
            - [ ] Tests passing
            - [ ] Ready for staging deployment
            
            ---
            ğŸ¤– *This PR was automatically created by Gitflow Automation*
          labels: |
            gitflow
            dev-to-staging
          draft: false

  # ===========================================================================
  # Staging â†’ Main PR (Release)
  # ===========================================================================
  staging-to-main:
    name: ğŸš€ Create Release PR (staging â†’ main)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          CHANGES=$(git log origin/main..staging --oneline | wc -l)
          echo "count=$CHANGES" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Found $CHANGES new commits ready for release"

      - name: Generate version
        id: version
        run: |
          # Basit tarih bazlÄ± versiyon
          VERSION="v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: Create Release Pull Request
        if: steps.changes.outputs.count > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: staging
          base: main
          title: "ğŸš€ [Release] ${{ steps.version.outputs.version }}"
          body: |
            ## ğŸš€ Release: ${{ steps.version.outputs.version }}
            
            Bu PR, **staging** branch'indeki deÄŸiÅŸiklikleri **production (main)**'e release eder.
            
            ### ğŸ“Š Release Info
            - Version: `${{ steps.version.outputs.version }}`
            - Commits: ${{ steps.changes.outputs.count }} commit(s)
            - Source: `staging`
            - Target: `main` (production)
            
            ### âš ï¸ Pre-Release Checklist
            - [ ] All features tested in staging
            - [ ] No critical bugs in staging
            - [ ] Database migrations ready (if any)
            - [ ] Rollback plan documented
            - [ ] Team notified about release
            
            ### ğŸ“ Release Notes
            <!-- Release notes buraya eklenecek -->
            
            ---
            ğŸ¤– *This release PR was automatically created by Gitflow Automation*
          labels: |
            gitflow
            release
            staging-to-main
          draft: false

  # ===========================================================================
  # Hotfix â†’ Main & Dev
  # ===========================================================================
  hotfix:
    name: ğŸ”¥ Hotfix PRs
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/hotfix/')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract hotfix name
        id: hotfix
        run: |
          HOTFIX_NAME=${GITHUB_REF#refs/heads/hotfix/}
          echo "name=$HOTFIX_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ”¥ Hotfix: $HOTFIX_NAME"

      - name: Create Hotfix PR to Main
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          base: main
          title: "ğŸ”¥ [Hotfix] ${{ steps.hotfix.outputs.name }} â†’ main"
          body: |
            ## ğŸ”¥ Hotfix: ${{ steps.hotfix.outputs.name }}
            
            **URGENT:** Bu hotfix doÄŸrudan production'a uygulanacak.
            
            ### âš ï¸ Hotfix Checklist
            - [ ] Issue identified and documented
            - [ ] Fix tested locally
            - [ ] No side effects
            - [ ] Ready for immediate deployment
            
            ---
            ğŸ¤– *This hotfix PR was automatically created*
          labels: |
            gitflow
            hotfix
            urgent
          draft: false

      - name: Create Hotfix PR to Dev
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          base: dev
          title: "ğŸ”¥ [Hotfix] ${{ steps.hotfix.outputs.name }} â†’ dev"
          body: |
            ## ğŸ”¥ Hotfix Backport: ${{ steps.hotfix.outputs.name }}
            
            Bu PR, hotfix'i dev branch'ine de uygular.
            
            ---
            ğŸ¤– *This hotfix backport PR was automatically created*
          labels: |
            gitflow
            hotfix
            backport
          draft: false
