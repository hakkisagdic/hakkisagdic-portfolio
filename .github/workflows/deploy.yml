name: Deploy Customer Stack

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CUSTOMER_NAME: ${{ vars.CUSTOMER_NAME }}
  ACR_NAME: ${{ vars.ACR_NAME }}
  IMAGE_NAME: ${{ vars.CUSTOMER_NAME }}/app

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=sha-${GITHUB_SHA::8}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Login to ACR
        if: github.event_name != 'pull_request'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

  deploy-dev:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/tmp/${{ env.CUSTOMER_NAME }}"
          strip_components: 0
      
      - name: Deploy to Swarm
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          envs: CUSTOMER_NAME,ACR_NAME
          script: |
            set -e
            
            # Variables
            DEPLOY_DIR="/opt/swarm/customers/${{ env.CUSTOMER_NAME }}"
            VERSION="${{ needs.build.outputs.version }}"
            
            # Create directory if not exists
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown $USER:$USER "$DEPLOY_DIR"
            
            # Copy docker-compose.yml from temp location
            cp "/tmp/${{ env.CUSTOMER_NAME }}/docker-compose.yml" "$DEPLOY_DIR/docker-compose.yml"
            rm -rf "/tmp/${{ env.CUSTOMER_NAME }}"
            
            cd "$DEPLOY_DIR"
            
            # Always update .env with current values
            echo "Updating .env file..."
            cat > .env << EOF
            # Auto-generated by CI/CD - $(date)
            VERSION=${VERSION}
            ACR_NAME=${{ env.ACR_NAME }}
            CUSTOMER_NAME=${{ env.CUSTOMER_NAME }}
            DOMAIN=${{ vars.DOMAIN }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            EOF
            echo ".env updated successfully"
            
            # Login to ACR
            echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_NAME }}.azurecr.io -u ${{ secrets.ACR_USERNAME }} --password-stdin
            
            # IMPORTANT: Docker Swarm doesn't read .env files automatically
            # Use docker-compose config to render the compose file with env vars
            echo "Rendering docker-compose with environment variables..."
            docker compose config > docker-compose.rendered.yml
            
            # Deploy stack with rendered compose file
            docker stack deploy -c docker-compose.rendered.yml --with-registry-auth ${{ env.CUSTOMER_NAME }}
            
            # Wait for services to start
            sleep 10
            
            # Show service status
            echo "=== Stack Services ==="
            docker stack services ${{ env.CUSTOMER_NAME }}
            
            echo "=== Deployment Complete ==="

  deploy-staging:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-rc')
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/tmp/${{ env.CUSTOMER_NAME }}"
      
      - name: Deploy to Staging
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          envs: CUSTOMER_NAME,ACR_NAME
          script: |
            set -e
            
            DEPLOY_DIR="/opt/swarm/customers/${{ env.CUSTOMER_NAME }}"
            VERSION="${{ needs.build.outputs.version }}"
            
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown $USER:$USER "$DEPLOY_DIR"
            cp "/tmp/${{ env.CUSTOMER_NAME }}/docker-compose.yml" "$DEPLOY_DIR/docker-compose.yml"
            rm -rf "/tmp/${{ env.CUSTOMER_NAME }}"
            
            cd "$DEPLOY_DIR"
            
            # Always update .env with current values
            cat > .env << EOF
            # Auto-generated by CI/CD - $(date)
            VERSION=${VERSION}
            ACR_NAME=${{ env.ACR_NAME }}
            CUSTOMER_NAME=${{ env.CUSTOMER_NAME }}
            DOMAIN=staging.${{ vars.DOMAIN }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            EOF
            
            echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_NAME }}.azurecr.io -u ${{ secrets.ACR_USERNAME }} --password-stdin
            
            # Render compose file with env vars and deploy
            docker compose config > docker-compose.rendered.yml
            docker stack deploy -c docker-compose.rendered.yml --with-registry-auth ${{ env.CUSTOMER_NAME }}
            
            sleep 10
            docker stack services ${{ env.CUSTOMER_NAME }}

  deploy-prod:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-rc') && !contains(github.ref, '-beta')
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/tmp/${{ env.CUSTOMER_NAME }}"
      
      - name: Deploy to Production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          envs: CUSTOMER_NAME,ACR_NAME
          script: |
            set -e
            
            DEPLOY_DIR="/opt/swarm/customers/${{ env.CUSTOMER_NAME }}"
            VERSION="${{ needs.build.outputs.version }}"
            
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown $USER:$USER "$DEPLOY_DIR"
            cp "/tmp/${{ env.CUSTOMER_NAME }}/docker-compose.yml" "$DEPLOY_DIR/docker-compose.yml"
            rm -rf "/tmp/${{ env.CUSTOMER_NAME }}"
            
            cd "$DEPLOY_DIR"
            
            # Backup existing .env
            if [ -f .env ]; then
              cp .env ".env.backup.$(date +%Y%m%d_%H%M%S)"
            fi
            
            # Always update .env with current values
            cat > .env << EOF
            # Auto-generated by CI/CD - $(date)
            VERSION=${VERSION}
            ACR_NAME=${{ env.ACR_NAME }}
            CUSTOMER_NAME=${{ env.CUSTOMER_NAME }}
            DOMAIN=${{ vars.DOMAIN }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            EOF
            
            echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_NAME }}.azurecr.io -u ${{ secrets.ACR_USERNAME }} --password-stdin
            
            # Render compose file with env vars and deploy
            docker compose config > docker-compose.rendered.yml
            docker stack deploy -c docker-compose.rendered.yml --with-registry-auth ${{ env.CUSTOMER_NAME }}
            
            sleep 30
            echo "=== Stack Services ==="
            docker stack services ${{ env.CUSTOMER_NAME }}
            echo "=== Production Deployment Complete ==="
