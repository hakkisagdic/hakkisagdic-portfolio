name: Deploy Customer Stack

on:
  push:
    branches: 
      - dev
      - staging
      - main
    tags: ['v*']
  pull_request:
    branches: [main, staging, dev]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  CUSTOMER_NAME: ${{ vars.CUSTOMER_NAME }}
  ACR_NAME: ${{ vars.ACR_NAME }}
  IMAGE_NAME: ${{ vars.CUSTOMER_NAME }}/app

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=sha-${GITHUB_SHA::8}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to ACR
        if: github.event_name != 'pull_request'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

  # ===========================================================================
  # DEV Deployment - Triggered by push to 'dev' branch
  # ===========================================================================
  deploy-dev:
    needs: build
    if: (github.ref == 'refs/heads/dev' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/tmp/${{ env.CUSTOMER_NAME }}"
          strip_components: 0
      
      - name: Deploy to DEV
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          envs: CUSTOMER_NAME,ACR_NAME
          script: |
            set -e
            
            DEPLOY_DIR="/opt/swarm/customers/${{ env.CUSTOMER_NAME }}"
            VERSION="${{ needs.build.outputs.version }}"
            
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown $USER:$USER "$DEPLOY_DIR"
            
            cp "/tmp/${{ env.CUSTOMER_NAME }}/docker-compose.yml" "$DEPLOY_DIR/docker-compose.yml"
            rm -rf "/tmp/${{ env.CUSTOMER_NAME }}"
            
            cd "$DEPLOY_DIR"
            
            # DEV environment: dev.domain.com, 1 replica
            echo "Updating .env file for DEV..."
            cat > .env << EOF
            # Auto-generated by CI/CD - $(date)
            # Environment: DEV
            # Branch: dev
            VERSION=${VERSION}
            ACR_NAME=${{ env.ACR_NAME }}
            CUSTOMER_NAME=${{ env.CUSTOMER_NAME }}
            DOMAIN=dev.${{ vars.DOMAIN }}
            REPLICAS=1
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            EOF
            
            echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_NAME }}.azurecr.io -u ${{ secrets.ACR_USERNAME }} --password-stdin
            
            source .env
            export VERSION ACR_NAME CUSTOMER_NAME DOMAIN REPLICAS DB_PASSWORD NEXTAUTH_SECRET
            cat docker-compose.yml | sed "s/\${VERSION:-latest}/$VERSION/g" | sed "s/\${REPLICAS:-1}/$REPLICAS/g" | envsubst > docker-compose.rendered.yml
            
            docker stack deploy -c docker-compose.rendered.yml --with-registry-auth ${{ env.CUSTOMER_NAME }}
            
            sleep 30
            echo "=== Stack Services ==="
            docker stack services ${{ env.CUSTOMER_NAME }}
            echo "=== DEV Deployment Complete ==="
            echo "üåê URL: https://dev.${{ vars.DOMAIN }}"

  # ===========================================================================
  # STAGING Deployment - Triggered by push to 'staging' branch
  # ===========================================================================
  deploy-staging:
    needs: build
    if: (github.ref == 'refs/heads/staging' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/tmp/${{ env.CUSTOMER_NAME }}"
      
      - name: Deploy to STAGING
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          envs: CUSTOMER_NAME,ACR_NAME
          script: |
            set -e
            
            DEPLOY_DIR="/opt/swarm/customers/${{ env.CUSTOMER_NAME }}"
            VERSION="${{ needs.build.outputs.version }}"
            
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown $USER:$USER "$DEPLOY_DIR"
            cp "/tmp/${{ env.CUSTOMER_NAME }}/docker-compose.yml" "$DEPLOY_DIR/docker-compose.yml"
            rm -rf "/tmp/${{ env.CUSTOMER_NAME }}"
            
            cd "$DEPLOY_DIR"
            
            # STAGING environment: stg.domain.com, 1 replica
            cat > .env << EOF
            # Auto-generated by CI/CD - $(date)
            # Environment: STAGING
            # Branch: staging
            VERSION=${VERSION}
            ACR_NAME=${{ env.ACR_NAME }}
            CUSTOMER_NAME=${{ env.CUSTOMER_NAME }}
            DOMAIN=stg.${{ vars.DOMAIN }}
            REPLICAS=1
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            EOF
            
            echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_NAME }}.azurecr.io -u ${{ secrets.ACR_USERNAME }} --password-stdin
            
            source .env
            export VERSION ACR_NAME CUSTOMER_NAME DOMAIN REPLICAS DB_PASSWORD NEXTAUTH_SECRET
            cat docker-compose.yml | sed "s/\${VERSION:-latest}/$VERSION/g" | sed "s/\${REPLICAS:-1}/$REPLICAS/g" | envsubst > docker-compose.rendered.yml
            docker stack deploy -c docker-compose.rendered.yml --with-registry-auth ${{ env.CUSTOMER_NAME }}
            
            sleep 30
            docker stack services ${{ env.CUSTOMER_NAME }}
            echo "=== STAGING Deployment Complete ==="
            echo "üåê URL: https://stg.${{ vars.DOMAIN }}"

  # ===========================================================================
  # PROD Deployment - Triggered by push to 'main' branch OR v* tag
  # ===========================================================================
  deploy-prod:
    needs: build
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/tmp/${{ env.CUSTOMER_NAME }}"
      
      - name: Deploy to PRODUCTION
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          envs: CUSTOMER_NAME,ACR_NAME
          script: |
            set -e
            
            DEPLOY_DIR="/opt/swarm/customers/${{ env.CUSTOMER_NAME }}"
            VERSION="${{ needs.build.outputs.version }}"
            
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown $USER:$USER "$DEPLOY_DIR"
            cp "/tmp/${{ env.CUSTOMER_NAME }}/docker-compose.yml" "$DEPLOY_DIR/docker-compose.yml"
            rm -rf "/tmp/${{ env.CUSTOMER_NAME }}"
            
            cd "$DEPLOY_DIR"
            
            # Backup existing .env
            if [ -f .env ]; then
              cp .env ".env.backup.$(date +%Y%m%d_%H%M%S)"
            fi
            
            # PROD environment: domain.com + www.domain.com, 2 replicas for HA
            cat > .env << EOF
            # Auto-generated by CI/CD - $(date)
            # Environment: PRODUCTION
            # Branch: main
            VERSION=${VERSION}
            ACR_NAME=${{ env.ACR_NAME }}
            CUSTOMER_NAME=${{ env.CUSTOMER_NAME }}
            DOMAIN=${{ vars.DOMAIN }}
            REPLICAS=2
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            EOF
            
            echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_NAME }}.azurecr.io -u ${{ secrets.ACR_USERNAME }} --password-stdin
            
            source .env
            export VERSION ACR_NAME CUSTOMER_NAME DOMAIN REPLICAS DB_PASSWORD NEXTAUTH_SECRET
            cat docker-compose.yml | sed "s/\${VERSION:-latest}/$VERSION/g" | sed "s/\${REPLICAS:-1}/$REPLICAS/g" | envsubst > docker-compose.rendered.yml
            docker stack deploy -c docker-compose.rendered.yml --with-registry-auth ${{ env.CUSTOMER_NAME }}
            
            sleep 30
            echo "=== Stack Services ==="
            docker stack services ${{ env.CUSTOMER_NAME }}
            echo "=== PRODUCTION Deployment Complete ==="
            echo "üåê URLs: https://${{ vars.DOMAIN }} and https://www.${{ vars.DOMAIN }}"
