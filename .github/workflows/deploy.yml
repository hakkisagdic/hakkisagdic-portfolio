name: Deploy Customer Stack

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CUSTOMER_NAME: ${{ vars.CUSTOMER_NAME }}
  ACR_NAME: ${{ vars.ACR_NAME }}
  IMAGE_NAME: ${{ vars.CUSTOMER_NAME }}/app

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=sha-${GITHUB_SHA::8}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Login to ACR
        if: github.event_name != 'pull_request'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

  deploy-dev:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Swarm
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          script: |
            cd /opt/swarm/customers/${{ env.CUSTOMER_NAME }}
            sed -i "s/^VERSION=.*/VERSION=${{ needs.build.outputs.version }}/" .env
            docker stack deploy -c docker-compose.yml --with-registry-auth ${{ env.CUSTOMER_NAME }}
            docker stack services ${{ env.CUSTOMER_NAME }}

  deploy-staging:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-rc')
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Staging
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          script: |
            cd /opt/swarm/customers/${{ env.CUSTOMER_NAME }}
            sed -i "s/^VERSION=.*/VERSION=${{ needs.build.outputs.version }}/" .env.staging
            cp .env.staging .env
            docker stack deploy -c docker-compose.yml --with-registry-auth ${{ env.CUSTOMER_NAME }}

  deploy-prod:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-rc') && !contains(github.ref, '-beta')
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          script: |
            cd /opt/swarm/customers/${{ env.CUSTOMER_NAME }}
            cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
            sed -i "s/^VERSION=.*/VERSION=${{ needs.build.outputs.version }}/" .env.prod
            cp .env.prod .env
            docker stack deploy -c docker-compose.yml --with-registry-auth ${{ env.CUSTOMER_NAME }}
            sleep 30
            docker stack services ${{ env.CUSTOMER_NAME }}
