# =============================================================================
# Branch Protection Auto-Setup
# =============================================================================
# Bu workflow, repo template'den oluÅŸturulduktan sonra ilk Ã§alÄ±ÅŸmada
# branch protection kurallarÄ±nÄ± otomatik olarak ayarlar.
#
# Gereksinim: Repository Settings > Actions > General > Workflow permissions
#             "Read and write permissions" seÃ§ili olmalÄ±
# =============================================================================

name: ðŸ”’ Setup Branch Protection

on:
  # Ä°lk push'ta otomatik Ã§alÄ±ÅŸÄ±r
  push:
    branches: [main]
  # Manuel tetikleme (gerekirse)
  workflow_dispatch:
    inputs:
      force_setup:
        description: 'Force re-setup of branch protection rules'
        required: false
        default: 'false'
        type: boolean

jobs:
  setup-protection:
    name: Configure Branch Protection Rules
    runs-on: ubuntu-latest
    # Sadece ilk Ã§alÄ±ÅŸmada VEYA force_setup true ise Ã§alÄ±ÅŸ
    if: github.run_number == 1 || inputs.force_setup == 'true'
    
    steps:
      - name: ðŸ” Setup Branch Protection
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log(`ðŸš€ Setting up branch protection for ${owner}/${repo}`);
            
            // Branch protection configurations
            const branchConfigs = [
              {
                branch: 'main',
                config: {
                  required_pull_request_reviews: {
                    required_approving_review_count: 1,
                    dismiss_stale_reviews: true,
                    require_code_owner_reviews: false
                  },
                  enforce_admins: false,
                  required_status_checks: {
                    strict: true,
                    contexts: ['build']
                  },
                  restrictions: null,
                  allow_force_pushes: false,
                  allow_deletions: false
                }
              },
              {
                branch: 'staging',
                config: {
                  required_pull_request_reviews: {
                    required_approving_review_count: 1,
                    dismiss_stale_reviews: false,
                    require_code_owner_reviews: false
                  },
                  enforce_admins: false,
                  required_status_checks: null,
                  restrictions: null,
                  allow_force_pushes: false,
                  allow_deletions: false
                }
              }
            ];
            
            for (const { branch, config } of branchConfigs) {
              try {
                // Ã–nce branch'in var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                try {
                  await github.rest.repos.getBranch({
                    owner,
                    repo,
                    branch
                  });
                } catch (e) {
                  if (e.status === 404) {
                    console.log(`â­ï¸ Branch '${branch}' does not exist yet, skipping...`);
                    continue;
                  }
                  throw e;
                }
                
                // Branch protection uygula
                await github.rest.repos.updateBranchProtection({
                  owner,
                  repo,
                  branch,
                  ...config
                });
                
                console.log(`âœ… Branch protection applied to '${branch}'`);
              } catch (error) {
                console.log(`âŒ Failed to protect '${branch}': ${error.message}`);
                // Hata olsa bile devam et
              }
            }
            
            console.log('ðŸŽ‰ Branch protection setup completed!');

      - name: ðŸ“ Summary
        run: |
          echo "## ðŸ”’ Branch Protection Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following branches have been protected:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | PR Required | Approvals | Status Checks |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|-----------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| main | âœ… | 1 | build |" >> $GITHUB_STEP_SUMMARY
          echo "| staging | âœ… | 1 | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note:** To re-run this setup, use the manual workflow dispatch with 'force_setup' enabled." >> $GITHUB_STEP_SUMMARY
